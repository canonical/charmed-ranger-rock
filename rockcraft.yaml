# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.
---

name: charmed-ranger-rock
base: ubuntu@22.04
version: 2.4.0-22.04-edge
summary: Charmed ranger ROCK OCI
description: |
  Apache Rangerâ„¢ is a framework to enable, monitor and
  manage comprehensive data security across the Hadoop platform.
license: Apache-2.0

platforms:
  amd64:

# Please refer to
# https://discourse.ubuntu.com/t/unifying-user-identity-across-snaps-and-rocks/36469
# for more information about shared user.
run_user: _daemon_

services:
  ranger-admin:
    override: replace
    summary: "ranger admin service"
    startup: disabled
    command: "/home/ranger/scripts/ranger-admin-entrypoint.sh"
    environment:
      JAVA_OPTS: "-Duser.timezone=UTC0"
  ranger-usersync:
    override: replace
    summary: "ranger usersync service"
    startup: disabled
    command: "/home/ranger/scripts/ranger-usersync-entrypoint.sh"

parts:
  base:
    plugin: dump
    source: "https://downloads.apache.org/ranger/2.4.0/apache-ranger-2.4.0.tar.gz" # yamllint disable-line
    source-checksum: "sha512/5bc934416e7239e2b74843399389a69e8c129322ff0a67b2e7a541a4dd2171357b10925ea29861c40e7590a6523494d46343fdda38049d9a66e48d80eed11a4b" # yamllint disable-line
    build-packages:
      - build-essential
      - curl
      - maven
      - git
      - openjdk-11-jdk-headless
    build-environment:
      - JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
      - RANGER_DIST: /home/ranger/dist
    override-build: |
      craftctl default

      # Build Ranger
      mvn clean compile package install \
        -DskipTests=true \
        -Dmaven.test.skip=true \
        -Drat.skip=true \
        -Dpmd.skip=true \
        -Dfindbugs.skip=true \
        -Dspotbugs.skip=true \
        -Dcheckstyle.skip=true \
        -Dmaven.wagon.http.ssl.insecure=true \
        -Dmaven.wagon.http.ssl.allowall=true \
        -Dmaven.wagon.http.ssl.ignore.validity.dates=true

      # Make dist directory
      mkdir -p ${CRAFT_PART_INSTALL}${RANGER_DIST}
      mv target ${CRAFT_PART_INSTALL}${RANGER_DIST}/target
    stage:
      - home/ranger/dist/target/ranger-2.4.0-admin.tar.gz
      - home/ranger/dist/target/ranger-2.4.0-usersync.tar.gz

  admin:
    after: [base]
    plugin: nil
    build-environment:
      - VERSION: "2.4.0"
      - RANGER_TARGET: /home/ranger/dist/target
      - RANGER_HOME: /usr/lib/ranger
    override-build: |
      craftctl default

      # Create directories
      mkdir -p \
        ${CRAFT_PART_INSTALL}${RANGER_HOME}/admin \
        ${CRAFT_PART_INSTALL}/var/run/ranger \
        ${CRAFT_PART_INSTALL}/var/log/ranger \
        ${CRAFT_PART_INSTALL}/usr/share/java

      # Unpack admin tar
      tar xvfz \
        ${CRAFT_STAGE}${RANGER_TARGET}/ranger-${VERSION}-admin.tar.gz \
        --directory=${CRAFT_PART_INSTALL}${RANGER_HOME}/admin \
        --strip-components=1
    stage:
      - usr/lib/ranger/admin
      - var/run/ranger
      - var/log/ranger
      - usr/share/java
    permissions:
      - path: usr/lib/ranger/admin
        owner: 584792
        group: 584792
        mode: "755"
      - path: var/run/ranger
        owner: 584792
        group: 584792
        mode: "755"
      - path: var/log/ranger
        owner: 584792
        group: 584792
        mode: "755"
      - path: usr/share/java
        owner: 584792
        group: 584792
        mode: "755"

  usersync:
    after: [base]
    plugin: nil
    build-environment:
      - VERSION: "2.4.0"
      - RANGER_TARGET: /home/ranger/dist/target
      - RANGER_HOME: /usr/lib/ranger
    override-build: |
      craftctl default

      # Create directories
      mkdir -p \
        ${CRAFT_PART_INSTALL}${RANGER_HOME}/usersync \
        ${CRAFT_PART_INSTALL}/var/log/ranger/usersync \
        ${CRAFT_PART_INSTALL}/etc/ranger

      # Unpack usersync tar
      tar xvfz \
        ${CRAFT_STAGE}${RANGER_TARGET}/ranger-${VERSION}-usersync.tar.gz \
        --directory=${CRAFT_PART_INSTALL}${RANGER_HOME}/usersync \
        --strip-components=1
    stage:
      - usr/lib/ranger/usersync
      - var/log/ranger/usersync
      - etc/ranger
    permissions:
      - path: usr/lib/ranger/usersync
        owner: 584792
        group: 584792
        mode: "755"
      - path: var/log/ranger/usersync
        owner: 584792
        group: 584792
        mode: "755"
      - path: etc/ranger
        owner: 584792
        group: 584792
        mode: "755"

  local-files:
    plugin: dump
    source: ./helper-scripts
    organize:
      admin-entrypoint.sh: home/ranger/scripts/ranger-admin-entrypoint.sh
      usersync-entrypoint.sh: home/ranger/scripts/ranger-usersync-entrypoint.sh
    stage:
      - home/ranger/scripts/ranger-admin-entrypoint.sh
      - home/ranger/scripts/ranger-usersync-entrypoint.sh
    permissions:
      - path: home/ranger/scripts
        owner: 584792
        group: 584792
        mode: "755"

  package-management:
    plugin: nil
    after: [admin, usersync]
    overlay-packages:
      - ca-certificates
      - python3
    overlay-script: |
      ln -s /usr/bin/python3 ${CRAFT_OVERLAY}/usr/bin/python
    stage-packages:
      - vim
      - openjdk-11-jdk-headless
      - libpostgresql-jdbc-java
